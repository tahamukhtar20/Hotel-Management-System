{% extends "base.html" %}
{% block head %}
    <title>Booking</title>
    <script src="{{ url_for('static', filename='js/Customer.js') }}"></script>
{% endblock %}
{% block body %}
    <div class="d-flex">
        <div class="px-5 py-3 rounded-4" style="background: #f1f3f3;">
            <div class="mx-3 my-2">
                <label for="calender" style="display :block" class="form-label">Date</label>
                <input class="calender" type="date" id="calender"
                       value="{{ min_date_str }}"
                       min="{{ min_date_str }}" max="{{ max_date_str }}" onchange="updateCalendar()">
            </div>
            <div class="mx-3 my-2">
                <label for="calender2" style="display :block" class="form-label">Date</label>
                <input class="calender" type="date" id="calender2"
                       value="{{ min_date_str_max }}"
                       min="{{ min_date_str_max }}" max="{{ max_date_str }}">
            </div>
            <div class="mx-3 my-2">
                <label for="room_type" class="form-label">Room Type</label>
                <select id="room_type" class="form-select">
                    <option class="py-3">VIP</option>
                    <option class="py-3">Luxury</option>
                    <option class="py-3">Economic</option>
                </select>
            </div>
            <div class="mx-3 my-2">
                <label for="bed_count" class="form-label">Bed Count</label>
                <select id="bed_count" class="form-select">
                    <option class="py-3">2</option>
                    <option class="py-3">3</option>
                </select>
            </div>
            <div>
                <button class="btn btn-primary mx-3 my-2" id="searching">Search</button>
            </div>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Room</th>
                <th scope="col">Type</th>
                <th scope="col">Bed Count</th>
                <th scope="col">Pricing</th>
            </tr>
            </thead>
            <tbody id="table_add_cart">
                {% for room in rooms %}
                    <tr>
                        <th scope="row">{{ room["id"] }}</th>
                        <td>{{ room["number"] }}</td>
                        <td>{{ room["type"] }}</td>
                        <td>{{ room["bed_count"] }}</td>
                        <td>{{ room["pricing"] }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        let calender = null;
        let calender2 = null;

        function checkingData(room) {
            let cart = sessionStorage.getItem("cart")
            cart = JSON.parse(cart)
            return cart[room] !== null;
        }

        function searching() {
            let selectedDate = document.getElementById('calender').value;
            let selectedDate2 = document.getElementById('calender2').value;
            let selectedRoomType = document.getElementById('room_type').value;
            let selectedBeds = document.getElementById('bed_count').value;
            calender = selectedDate
            calender2 = selectedDate2
            $.ajax({
                url: '/get-data',
                type: 'POST',
                dataType: 'json',
                data: {
                    checkin: selectedDate,
                    checkout: selectedDate2,
                    room_type: selectedRoomType,
                    bed_count: selectedBeds
                },
                success: function (data) {
                    let tableData = data
                        .map((item, i) => ({
                            Room: item.Room,
                            Type: item.Type,
                            Number_of_Beds: item.Number_of_Beds,
                            Price: item.Price,
                            index: i
                        }))
                    let table = document.getElementById('table_add_cart');
                    while (table.firstChild) {
                        table.removeChild(table.firstChild);
                    }
                    for (let i = 0; i < tableData.length; i++) {
                        let cart = JSON.parse(sessionStorage.getItem('cart'));
                        if (cart && cart[tableData[i].Room]) {
                            continue;
                        }
                        let row = document.createElement('tr');
                        row.innerHTML = `<td>${tableData[i].Room}</td><td>${tableData[i].Type}</td><td>${tableData[i].Number_of_Beds}</td><td>${tableData[i].Price}</td><td><button class="btn btn-primary" id="add_cart" onclick="addToCart('${tableData[i].Room}', '${tableData[i].Type}', '${tableData[i].Number_of_Beds}', '${tableData[i].Price}', this.parentNode.parentNode)">Add to Cart</button></td>`;
                        document.getElementById('table_add_cart').appendChild(row);
                    }
                }
            });
        }

        function updateCalendar() {
            let selectedDate = document.getElementById('calender').value;
            let minDate = new Date(selectedDate);
            minDate.setDate(minDate.getDate() + 1);
            document.getElementById('calender2').min = minDate.toISOString().substr(0, 10);
            document.getElementById('calender2').value = document.getElementById('calender2').min;
        }

        const tbody_ = document.getElementById('table_add_cart');

        tbody_.addEventListener('click', function (event) {
            if (event.target.tagName === 'BUTTON') {
                const row = event.target.parentNode.parentNode;
                const cells = row.children;
                const Room = cells[0].textContent;
                const Type = cells[1].textContent;
                const Number_of_Beds = cells[2].textContent;
                const Price = cells[3].textContent;
                addToCart(Room, Type, Number_of_Beds, Price, row);
            }
        });

        function addToCart(Room, Type, Number_of_Beds, Price, row) {
            let room_no = Room
            let newItem = [Room, Type, Number_of_Beds, Price, calender, calender2]
            if (sessionStorage.getItem('cart')) {
                let cart = JSON.parse(sessionStorage.getItem('cart'));
                cart[room_no] = newItem;
                sessionStorage.setItem('cart', JSON.stringify(cart));
            } else {
                let cart = {};
                cart[room_no] = newItem;
                sessionStorage.setItem('cart', JSON.stringify(cart));
            }
            if (row) {
                row.remove();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById("searching").addEventListener('click', searching)
        });
    </script>
{% endblock %}